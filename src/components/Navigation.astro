---
import PremiumThemeToggle from "./ui/premium-theme-toggle.tsx";
import PremiumMotionToggle from "./ui/premium-motion-toggle.tsx";
---

<nav
  id="main-nav"
  class="cursor-target fixed top-0 left-0 right-0 z-50 transition-all duration-500 ease-out"
  role="navigation"
  aria-label="Primary"
  data-nav-state="expanded"
>
  <!-- Sophisticated Progress indicator -->
  <div class="absolute bottom-0 left-0 h-[2px] bg-gradient-to-r from-primary via-accent to-primary transition-all duration-300 ease-out shadow-glow" id="scroll-progress"></div>
  
  <div class="nav-container transition-all duration-500 ease-out px-4 sm:px-6 lg:px-8">
    <div class="flex h-20 items-center justify-between">
      <!-- Premium Brand -->
      <a href="/" class="cursor-target nav-brand flex items-center gap-2 sm:gap-3 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded-lg px-2 py-1 group transition-all duration-500">
        <span class="text-2xl font-bold text-foreground group-hover:text-primary transition-colors duration-300">SD<span class="text-primary">.</span></span>
      </a>

      <!-- Centered Navigation with Pill Design -->
      <div class="nav-center-wrapper hidden md:block absolute left-1/2 transform -translate-x-1/2" id="nav-center">
        <div class="nav-pill bg-card/50 backdrop-blur-xl rounded-full px-6 py-3 border border-border/30 shadow-card">
          <ul class="nav-links flex items-center space-x-1 text-sm transition-all duration-500">
            <li><a href="#home" class="cursor-target nav-link px-4 py-2 text-muted-foreground hover:text-foreground hover:bg-primary/10 rounded-full font-medium relative transition-all duration-300" data-section="home"><span class="relative z-10">Home</span></a></li>
            <li><a href="#about" class="cursor-target nav-link px-4 py-2 text-muted-foreground hover:text-foreground hover:bg-primary/10 rounded-full font-medium relative transition-all duration-300" data-section="about"><span class="relative z-10">About</span></a></li>
            <li><a href="#skills" class="cursor-target nav-link px-4 py-2 text-muted-foreground hover:text-foreground hover:bg-primary/10 rounded-full font-medium relative transition-all duration-300" data-section="skills"><span class="relative z-10">Skills</span></a></li>
            <li><a href="#experience" class="cursor-target nav-link px-4 py-2 text-muted-foreground hover:text-foreground hover:bg-primary/10 rounded-full font-medium relative transition-all duration-300" data-section="experience"><span class="relative z-10">Experience</span></a></li>
            <li><a href="#projects" class="cursor-target nav-link px-4 py-2 text-muted-foreground hover:text-foreground hover:bg-primary/10 rounded-full font-medium relative transition-all duration-300" data-section="projects"><span class="relative z-10">Projects</span></a></li>
            <li><a href="#contact" class="cursor-target nav-link px-4 py-2 text-muted-foreground hover:text-foreground hover:bg-primary/10 rounded-full font-medium relative transition-all duration-300" data-section="contact"><span class="relative z-10">Contact</span></a></li>
          </ul>
        </div>
      </div>

      <!-- Premium Controls -->
      <div class="nav-utilities hidden md:flex items-center gap-2 lg:gap-4 transition-all duration-500">
        <div class="cursor-target">
          <PremiumThemeToggle client:load />
        </div>
        <div class="cursor-target">
          <PremiumMotionToggle client:load />
        </div>
      </div>

      <!-- Mobile: hamburger and utilities -->
      <div class="md:hidden flex items-center gap-2 sm:gap-3">
        <div class="flex items-center gap-1 sm:gap-2">
          <div class="cursor-target">
            <PremiumThemeToggle client:load />
          </div>
          <div class="cursor-target">
            <PremiumMotionToggle client:load />
          </div>
        </div>
        <button
          class="cursor-target mobile-menu-btn inline-flex h-10 w-10 items-center justify-center rounded-lg bg-card/50 backdrop-blur-sm border border-border/30 text-foreground hover:bg-card hover:border-border transition-all duration-300"
          type="button"
          aria-controls="mobile-menu"
          aria-expanded="false"
          aria-label="Open menu"
          data-menu-toggle
        >
          <svg class="h-6 w-6 hamburger-icon transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile menu - fully responsive -->
  <div id="mobile-menu" class="md:hidden mobile-menu-container">
    <div class="px-4 sm:px-6 pb-6 pt-2 border-t border-border/10 bg-background/98 backdrop-blur-sm">
      <ul class="grid gap-1 text-sm">
        <li><a href="#home" class="mobile-nav-link block rounded-lg px-4 py-3 text-muted-foreground hover:text-foreground hover:bg-card/50 transition-all duration-200">Home</a></li>
        <li><a href="#about" class="mobile-nav-link block rounded-lg px-4 py-3 text-muted-foreground hover:text-foreground hover:bg-card/50 transition-all duration-200">About</a></li>
        <li><a href="#projects" class="mobile-nav-link block rounded-lg px-4 py-3 text-muted-foreground hover:text-foreground hover:bg-card/50 transition-all duration-200">Projects</a></li>
        <li><a href="#contact" class="mobile-nav-link block rounded-lg px-4 py-3 text-muted-foreground hover:text-foreground hover:bg-card/50 transition-all duration-200">Contact</a></li>
      </ul>
    </div>
  </div>
</nav>

<style>
  /* Sophisticated Navbar states and transitions */
  #main-nav {
    background: hsl(var(--background) / 0.90);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid hsl(var(--border) / 0.1);
  }

  /* Expanded state (default) */
  #main-nav[data-nav-state="expanded"] .nav-container {
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Converged state (while scrolling) - Professional center convergence */
  #main-nav[data-nav-state="converged"] {
    background: hsl(var(--background) / 0.95);
    backdrop-filter: blur(24px);
    border-bottom: 1px solid hsl(var(--border) / 0.2);
    box-shadow: var(--shadow-card);
  }

  #main-nav[data-nav-state="converged"] .nav-container {
    max-width: 900px;
    margin: 0 auto;
  }

  #main-nav[data-nav-state="converged"] .nav-pill {
    transform: scale(0.95);
    background: hsl(var(--card) / 0.8);
    border-color: hsl(var(--border) / 0.5);
  }

  #main-nav[data-nav-state="converged"] .nav-brand {
    transform: scale(0.9);
  }

  #main-nav[data-nav-state="converged"] .nav-utilities {
    transform: scale(0.9);
    gap: 0.5rem;
  }

  /* Sophisticated Active nav link indicator */
  .nav-link.active {
    background: hsl(var(--primary) / 0.1);
    color: hsl(var(--foreground));
  }
  
  .nav-link.active::before {
    content: '';
    position: absolute;
    inset: 0;
    background: hsl(var(--primary) / 0.05);
    border-radius: 9999px;
    border: 1px solid hsl(var(--primary) / 0.2);
  }

  /* Mobile menu transitions */
  .mobile-menu-container {
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease-out;
    pointer-events: none;
  }

  .mobile-menu-container.open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  /* Hamburger animation */
  .mobile-menu-btn[aria-expanded="true"] .hamburger-icon {
    transform: rotate(90deg);
  }

  /* Responsive utilities */
  @media (max-width: 640px) {
    #main-nav .nav-container {
      padding-left: 1rem;
      padding-right: 1rem;
    }
    
    #main-nav[data-nav-state="converged"] .nav-container {
      max-width: 100%;
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
  }

  /* Progressive enhancement: CSS-only mobile menu toggle */
  @supports selector(nav:has(button[data-menu-toggle][aria-expanded="true"])) {
    nav:has(button[data-menu-toggle][aria-expanded="true"]) .mobile-menu-container {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
  }
</style>

<script is:raw>
  (function () {
    const nav = document.currentScript?.closest('nav');
    if (!nav) return;
    
    const btn = nav.querySelector('button[data-menu-toggle]');
    const menu = nav.querySelector('#mobile-menu');
    const progressBar = nav.querySelector('#scroll-progress');
    const navLinks = nav.querySelectorAll('.nav-link');
    
    let isScrolling = false;
    let scrollTimeout;

    // Mobile menu functionality
    if (btn && menu) {
      function closeOnEscape(e) {
        if (e.key === 'Escape') {
          closeMenu();
        }
      }

      function closeMenu() {
        btn.setAttribute('aria-expanded', 'false');
        btn.setAttribute('aria-label', 'Open menu');
        menu.classList.remove('open');
      }

      function openMenu() {
        btn.setAttribute('aria-expanded', 'true');
        btn.setAttribute('aria-label', 'Close menu');
        menu.classList.add('open');
      }

      btn.addEventListener('click', () => {
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        expanded ? closeMenu() : openMenu();
      });

      // Close menu when clicking nav links
      menu.querySelectorAll('.mobile-nav-link').forEach(link => {
        link.addEventListener('click', closeMenu);
      });

      document.addEventListener('keydown', closeOnEscape);
    }

    // Innovative scroll behavior - convergence effect
    function updateNavOnScroll() {
      const scrollY = window.scrollY;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight - windowHeight;
      const scrollProgress = Math.min(scrollY / documentHeight, 1);
      
      // Update progress bar
      if (progressBar) {
        progressBar.style.width = `${scrollProgress * 100}%`;
      }

      // Convergence effect based on scroll position
      const convergenceThreshold = 100;
      const maxConvergence = 300;
      
      if (scrollY > convergenceThreshold) {
        const convergenceProgress = Math.min((scrollY - convergenceThreshold) / maxConvergence, 1);
        nav.setAttribute('data-nav-state', 'converged');
        
        // Add subtle scale and opacity effects based on scroll speed
        if (!isScrolling) {
          isScrolling = true;
          nav.style.transform = 'translateY(-2px)';
        }
        
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          isScrolling = false;
          nav.style.transform = 'translateY(0)';
        }, 150);
      } else {
        nav.setAttribute('data-nav-state', 'expanded');
      }
    }

    // Active section detection
    function updateActiveLink() {
      const sections = document.querySelectorAll('section[id]');
      const scrollPos = window.scrollY + 100;

      sections.forEach(section => {
        const sectionTop = section.offsetTop;
        const sectionHeight = section.offsetHeight;
        const sectionId = section.getAttribute('id');
        
        if (scrollPos >= sectionTop && scrollPos < sectionTop + sectionHeight) {
          navLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-section') === sectionId) {
              link.classList.add('active');
            }
          });
        }
      });
    }

    // Smooth scroll for nav links
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href').substring(1);
        const targetSection = document.getElementById(targetId);
        
        if (targetSection) {
          const navHeight = nav.offsetHeight;
          const targetPos = targetSection.offsetTop - navHeight - 20;
          
          window.scrollTo({
            top: targetPos,
            behavior: 'smooth'
          });
        }
      });
    });

    // Throttled scroll listener for performance
    let scrollTicking = false;
    function onScroll() {
      if (!scrollTicking) {
        requestAnimationFrame(() => {
          updateNavOnScroll();
          updateActiveLink();
          scrollTicking = false;
        });
        scrollTicking = true;
      }
    }

    // Initialize
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', () => {
      // Recalculate on resize
      updateNavOnScroll();
      updateActiveLink();
    });
    
    // Initial calls
    updateNavOnScroll();
    updateActiveLink();
  })();
</script>